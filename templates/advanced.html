{% extends "base.html" %}
{% block content %}
<h2>Advanced Mode</h2>
<div class="box">
  <h3>Step 1</h3>
  <div class="button-row">
    <button id="get-ips-btn" title="Open a log file and work out what the External IP address is, and get Prowlarr IP">Get IP's</button>
    <button id="toggle-debug-btn" title="Show/Hide debug information" style="display:none;">Show Debug</button>
  </div>
  <div id="ips-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="debug-info" style="margin-top:1em;font-size:0.8em;color:#666;background:#f5f5f5;padding:0.5em;border-radius:4px;white-space:pre-line;max-height:200px;overflow-y:auto;display:none;"></div>
</div>
<div class="box">
  <h3>Step 2</h3>
  <div class="button-row">
    <button id="login-mam-btn" title="Login to MAM using Selenium for JavaScript support">Login to MAM</button>
    <button id="view-mam-page-btn" title="Open MAM website in a new browser window">Open MAM Page</button>
    <button id="view-sessions-btn" title="Switch to the security page of myananamouse">View Sessions</button>
    <button id="delete-old-sessions-btn" title="Delete all of the old sessions">Delete old Sessions</button>
    <button id="create-qbittorrent-session-btn" title="Creates a new session for Myanonamouse qbtitorrent client that is ASN Locked and Allow Session to set Dynamic SeedBox. Copy cookie generated by Myanonamouse">Create qBittorrent Session</button>
    <button id="create-prowlarr-session-btn" title="Creates a session for the Prowlarr Docker">Create Prowlarr Session</button>
    <button title="Logout of MAM">Logout MAM</button>
  </div>
  <div id="mam-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="mam-debug" style="margin-top:0.5em;font-size:0.8em;color:#666;background:#f5f5f5;padding:0.5em;border-radius:4px;white-space:pre-line;max-height:200px;overflow-y:auto;display:none;"></div>
  <button id="toggle-mam-debug" style="margin-top:0.5em;display:none;" title="Show/Hide MAM debug information">Show Debug</button>
  
  <!-- Session Cookies Display -->
  <div style="margin-top:1.5em;">
    <h4>Session Cookies:</h4>
    <div style="margin-bottom:1em;">
      <label style="display:block;margin-bottom:0.3em;font-weight:600;">qBittorrent Cookie:</label>
      <textarea id="qbittorrent-cookie-display" readonly style="width:100%;height:60px;font-family:monospace;font-size:0.8em;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;padding:0.5em;resize:vertical;" placeholder="No cookie generated yet..."></textarea>
    </div>
    <div>
      <label style="display:block;margin-bottom:0.3em;font-weight:600;">Prowlarr Cookie:</label>
      <textarea id="prowlarr-cookie-display" readonly style="width:100%;height:60px;font-family:monospace;font-size:0.8em;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;padding:0.5em;resize:vertical;" placeholder="No cookie generated yet..."></textarea>
    </div>
  </div>
</div>
<div class="box">
  <h3>Step 3</h3>
  <div class="button-row">
    <button title="Open a console window on the Qbittorrent docker">Log into qBittorrent</button>
    <button title="Send the cookie to qbittorrent in a command and check success">Send Cookie to qBittorrent</button>
    <button title="Logout of qBittorrent">Logout qBittorrent</button>
  </div>
</div>
<div class="box">
  <h3>Step 4</h3>
  <div class="button-row">
    <button title="Open window into the Prowlarr Docker">Log into Prowlarr</button>
    <button title="Send Prowlarr Cookie">Send Prowlarr Cookie</button>
    <button title="Logout of Prowlarr">Logout of Prowlarr</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const getIpsBtn = document.getElementById('get-ips-btn');
  const toggleDebugBtn = document.getElementById('toggle-debug-btn');
  const resultDiv = document.getElementById('ips-result');
  const debugDiv = document.getElementById('debug-info');
  const loginMamBtn = document.getElementById('login-mam-btn');
  const viewMamPageBtn = document.getElementById('view-mam-page-btn');
  const viewSessionsBtn = document.getElementById('view-sessions-btn');
  const deleteOldSessionsBtn = document.getElementById('delete-old-sessions-btn');
  const mamResultDiv = document.getElementById('mam-result');
  const mamDebugDiv = document.getElementById('mam-debug');
  const toggleMamDebugBtn = document.getElementById('toggle-mam-debug');
  const createQbittorrentSessionBtn = document.getElementById('create-qbittorrent-session-btn');
  const createProwlarrSessionBtn = document.getElementById('create-prowlarr-session-btn');
  const qbittorrentCookieDisplay = document.getElementById('qbittorrent-cookie-display');
  const prowlarrCookieDisplay = document.getElementById('prowlarr-cookie-display');
  
  // Function to load and display existing cookies
  function loadExistingCookies() {
    fetch('/api/settings')
      .then(r => r.json())
      .then(settings => {
        if (settings.qbittorrent_session_cookie) {
          qbittorrentCookieDisplay.value = settings.qbittorrent_session_cookie;
          qbittorrentCookieDisplay.placeholder = '';
        }
        if (settings.prowlarr_session_cookie) {
          prowlarrCookieDisplay.value = settings.prowlarr_session_cookie;
          prowlarrCookieDisplay.placeholder = '';
        }
      })
      .catch(error => {
        console.log('Could not load existing cookies:', error);
      });
  }
  
  // Load existing cookies on page load
  loadExistingCookies();
  
  if (getIpsBtn) {
    getIpsBtn.addEventListener('click', function() {
      resultDiv.textContent = 'Fetching IPs...';
      debugDiv.style.display = 'none';
      toggleDebugBtn.style.display = 'none';
      
      fetch('/api/get_ips').then(r => r.json()).then(data => {
        let html = '';
        if (data.external_ip && data.external_ip !== 'Error') {
          html += `External IP: <span style='color:#007700'>${data.external_ip}</span><br>`;
        } else {
          html += `External IP: <span style='color:#bb0000'>Not found/Error</span><br>`;
        }
        if (data.vpn_ip && data.vpn_ip !== 'Not Found') {
          html += `VPN Container IP: <span style='color:#0077bb'>${data.vpn_ip}</span>`;
        } else {
          html += `VPN Container IP: <span style='color:#bb0000'>Not found</span>`;
        }
        resultDiv.innerHTML = html;
        
        // Show debug info if available
        if (data.debug_info && data.debug_info.length > 0) {
          debugDiv.textContent = data.debug_info.join('\n');
          toggleDebugBtn.style.display = 'inline-block';
          toggleDebugBtn.textContent = 'Show Debug';
        }
      }).catch((error) => {
        resultDiv.textContent = 'Failed to fetch IPs: ' + error.message;
      });
    });
  }
  
  if (toggleDebugBtn) {
    toggleDebugBtn.addEventListener('click', function() {
      if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
        toggleDebugBtn.textContent = 'Hide Debug';
      } else {
        debugDiv.style.display = 'none';
        toggleDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // Log into MAM button functionality
  if (loginMamBtn) {
    loginMamBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Logging into MAM using Selenium...';
      mamResultDiv.style.color = '#666';
      loginMamBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/login_mam', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        loginMamBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.redirect_url) {
            mamResultDiv.innerHTML += `<br><small>Redirected to: ${data.redirect_url}</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        loginMamBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // MAM debug toggle functionality
  if (toggleMamDebugBtn) {
    toggleMamDebugBtn.addEventListener('click', function() {
      if (mamDebugDiv.style.display === 'none') {
        mamDebugDiv.style.display = 'block';
        toggleMamDebugBtn.textContent = 'Hide Debug';
      } else {
        mamDebugDiv.style.display = 'none';
        toggleMamDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // View MAM Page button functionality - opens popup showing current global browser state
  if (viewMamPageBtn) {
    viewMamPageBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Getting current browser state...';
      mamResultDiv.style.color = '#666';
      
      // Get current state of global browser
      fetch('/api/view_mam_page')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Show status information
            let statusMsg = data.logged_in ? 'Logged in' : 'Not logged in';
            mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${statusMsg} - Opening current page in new window</span>`;
            
            // Open the CURRENT URL of the global browser in a new window
            const currentUrl = data.url || 'https://www.myanonamouse.net/';
            const newWindow = window.open(currentUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (newWindow) {
              mamResultDiv.innerHTML += `<br><small>Opened: ${data.title || currentUrl}</small>`;
            } else {
              mamResultDiv.innerHTML += `<br><span style='color:#bb0000'>⚠ Popup blocked - please allow popups for this site</span>`;
            }
          } else {
            mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Error: ${data.error}</span>`;
          }
        })
        .catch(error => {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Error: ${error.message}</span>`;
        });
    });
  }
  
  // View Sessions button functionality
  if (viewSessionsBtn) {
    viewSessionsBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Loading sessions page...';
      mamResultDiv.style.color = '#666';
      viewSessionsBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/view_sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        viewSessionsBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.session_count) {
            mamResultDiv.innerHTML += `<br><small>Sessions found: ${data.session_count}</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        viewSessionsBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Delete Old Sessions button functionality
  if (deleteOldSessionsBtn) {
    deleteOldSessionsBtn.addEventListener('click', function() {
      // Confirmation dialog
      if (!confirm('Are you sure you want to delete all old sessions except the newest one? This action cannot be undone.')) {
        return;
      }
      
      mamResultDiv.textContent = 'Deleting old sessions...';
      mamResultDiv.style.color = '#666';
      deleteOldSessionsBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/delete_old_sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        deleteOldSessionsBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.deleted_count !== undefined) {
            mamResultDiv.innerHTML += `<br><small>Deleted: ${data.deleted_count} sessions</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        deleteOldSessionsBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Create qBittorrent Session Cookie button functionality
  if (createQbittorrentSessionBtn) {
    createQbittorrentSessionBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Creating qBittorrent session cookie...';
      mamResultDiv.style.color = '#666';
      createQbittorrentSessionBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/create_qbittorrent_cookie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        createQbittorrentSessionBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          
          // Update the cookie display
          loadExistingCookies();
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        createQbittorrentSessionBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Create Prowlarr Session Cookie button functionality
  if (createProwlarrSessionBtn) {
    createProwlarrSessionBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Creating Prowlarr session cookie...';
      mamResultDiv.style.color = '#666';
      createProwlarrSessionBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/create_prowlarr_cookie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        createProwlarrSessionBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          
          // Update the cookie display
          loadExistingCookies();
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        createProwlarrSessionBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
});
</script>
{% endblock %}
