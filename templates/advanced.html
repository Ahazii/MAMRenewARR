{% extends "base.html" %}
{% block content %}
<h2>Advanced Mode</h2>
<div class="box">
  <h3>Step 1</h3>
  <div class="button-row">
    <button id="get-ips-btn" title="Open a log file and work out what the External IP address is, and get Prowlarr IP">Get IP's</button>
    <button id="restart-qbittorrent-btn" title="Restart the binhex-qbittorrentvpn Docker container">Restart qBittorrentvpn</button>
    <button id="toggle-debug-btn" title="Show/Hide debug information" style="display:none;">Show Debug</button>
  </div>
  <div id="ips-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="restart-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="debug-info" class="debug-info" style="margin-top:1em;font-size:0.8em;max-height:200px;display:none;"></div>
</div>
<div class="box">
  <h3>Step 2</h3>
  <div class="button-row">
    <button id="login-mam-btn" title="Login to MAM using Selenium for JavaScript support">Login to MAM</button>
    <button id="view-mam-page-btn" title="Open MAM website in a new browser window">Open MAM Page</button>
    <button id="view-sessions-btn" title="Switch to the security page of myananamouse">View Sessions</button>
    <button id="delete-old-sessions-btn" title="Delete all of the old sessions">Delete old Sessions</button>
    <button id="create-qbittorrent-session-btn" title="Creates a new session for Myanonamouse qbtitorrent client that is ASN Locked and Allow Session to set Dynamic SeedBox. Copy cookie generated by Myanonamouse">Create qBittorrent Session</button>
    <button id="create-prowlarr-session-btn" title="Creates a session for the Prowlarr Docker">Create Prowlarr Session</button>
    <button id="logout-mam-btn" title="Logout of MAM">Logout MAM</button>
    <button id="clear-cookies-btn" title="Clear both session cookies and reset timestamps">Clear Cookies</button>
  </div>
  <div id="mam-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="mam-debug" class="debug-info" style="margin-top:0.5em;font-size:0.8em;max-height:200px;display:none;"></div>
  <button id="toggle-mam-debug" style="margin-top:0.5em;display:none;" title="Show/Hide MAM debug information">Show Debug</button>
  
  <!-- Session Cookies Display -->
  <div style="margin-top:1.5em;">
    <h4>Session Cookies:</h4>
    <div style="margin-bottom:1em;">
      <label id="qbittorrent-cookie-label" style="display:block;margin-bottom:0.3em;font-weight:600;">qBittorrent Cookie:</label>
      <textarea id="qbittorrent-cookie-display" readonly style="width:100%;height:60px;font-family:monospace;font-size:0.8em;border-radius:4px;padding:0.5em;resize:vertical;" placeholder="No cookie generated yet..."></textarea>
    </div>
    <div>
      <label id="prowlarr-cookie-label" style="display:block;margin-bottom:0.3em;font-weight:600;">Prowlarr Cookie:</label>
      <textarea id="prowlarr-cookie-display" readonly style="width:100%;height:60px;font-family:monospace;font-size:0.8em;border-radius:4px;padding:0.5em;resize:vertical;" placeholder="No cookie generated yet..."></textarea>
    </div>
  </div>
</div>
<div class="box">
  <h3>Step 3</h3>
  <div class="button-row">
    <button id="qbittorrent-login-btn" title="Open a console window on the Qbittorrent docker">Log into qBittorrent</button>
    <button id="qbittorrent-send-cookie-btn" title="Send the cookie to qbittorrent in a command and check success">Send Cookie to qBittorrent</button>
    <button id="qbittorrent-logout-btn" title="Logout of qBittorrent">Logout qBittorrent</button>
  </div>
  <div id="qbittorrent-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="qbittorrent-debug" class="debug-info" style="margin-top:0.5em;font-size:0.8em;max-height:200px;display:none;"></div>
  <button id="toggle-qbittorrent-debug" style="margin-top:0.5em;display:none;" title="Show/Hide qBittorrent debug information">Show Debug</button>
</div>
<div class="box">
  <h3>Step 4</h3>
  <div class="button-row">
    <button id="prowlarr-login-btn" title="Open browser to Prowlarr web interface">Log into Prowlarr</button>
    <button id="prowlarr-send-cookie-btn" title="Update MyAnonamouse indexer with Prowlarr cookie">Send Cookie to Prowlarr</button>
    <button id="prowlarr-logout-btn" title="Close Prowlarr browser session">Logout Prowlarr</button>
  </div>
  <div id="prowlarr-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="prowlarr-debug" class="debug-info" style="margin-top:0.5em;font-size:0.8em;max-height:200px;display:none;"></div>
  <button id="toggle-prowlarr-debug" style="margin-top:0.5em;display:none;" title="Show/Hide Prowlarr debug information">Show Debug</button>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const getIpsBtn = document.getElementById('get-ips-btn');
  const restartQbittorrentBtn = document.getElementById('restart-qbittorrent-btn');
  const toggleDebugBtn = document.getElementById('toggle-debug-btn');
  const resultDiv = document.getElementById('ips-result');
  const restartResultDiv = document.getElementById('restart-result');
  const debugDiv = document.getElementById('debug-info');
  const loginMamBtn = document.getElementById('login-mam-btn');
  const viewMamPageBtn = document.getElementById('view-mam-page-btn');
  const viewSessionsBtn = document.getElementById('view-sessions-btn');
  const deleteOldSessionsBtn = document.getElementById('delete-old-sessions-btn');
  const mamResultDiv = document.getElementById('mam-result');
  const mamDebugDiv = document.getElementById('mam-debug');
  const toggleMamDebugBtn = document.getElementById('toggle-mam-debug');
  const createQbittorrentSessionBtn = document.getElementById('create-qbittorrent-session-btn');
  const createProwlarrSessionBtn = document.getElementById('create-prowlarr-session-btn');
  const logoutMamBtn = document.getElementById('logout-mam-btn');
  const clearCookiesBtn = document.getElementById('clear-cookies-btn');
  const qbittorrentLoginBtn = document.getElementById('qbittorrent-login-btn');
  const qbittorrentSendCookieBtn = document.getElementById('qbittorrent-send-cookie-btn');
  const qbittorrentLogoutBtn = document.getElementById('qbittorrent-logout-btn');
  const qbittorrentResultDiv = document.getElementById('qbittorrent-result');
  const qbittorrentDebugDiv = document.getElementById('qbittorrent-debug');
  const toggleQbittorrentDebugBtn = document.getElementById('toggle-qbittorrent-debug');
  const qbittorrentCookieDisplay = document.getElementById('qbittorrent-cookie-display');
  const prowlarrCookieDisplay = document.getElementById('prowlarr-cookie-display');
  const qbittorrentCookieLabel = document.getElementById('qbittorrent-cookie-label');
  const prowlarrCookieLabel = document.getElementById('prowlarr-cookie-label');
  const prowlarrLoginBtn = document.getElementById('prowlarr-login-btn');
  const prowlarrSendCookieBtn = document.getElementById('prowlarr-send-cookie-btn');
  const prowlarrLogoutBtn = document.getElementById('prowlarr-logout-btn');
  const prowlarrResultDiv = document.getElementById('prowlarr-result');
  const prowlarrDebugDiv = document.getElementById('prowlarr-debug');
  const toggleProwlarrDebugBtn = document.getElementById('toggle-prowlarr-debug');
  
  // Function to load and display existing cookies
  function loadExistingCookies() {
    fetch('/api/settings')
      .then(r => r.json())
      .then(settings => {
        // Update qBittorrent cookie and label
        if (settings.qbittorrent_session_cookie) {
          qbittorrentCookieDisplay.value = settings.qbittorrent_session_cookie;
          qbittorrentCookieDisplay.placeholder = '';
          
          let qbLabel = 'qBittorrent Cookie';
          if (settings.qbittorrent_cookie_obtained_time) {
            qbLabel += ' - Time/Date Obtained: ' + settings.qbittorrent_cookie_obtained_time;
          }
          qbittorrentCookieLabel.textContent = qbLabel;
        } else {
          qbittorrentCookieLabel.textContent = 'qBittorrent Cookie:';
        }
        
        // Update Prowlarr cookie and label
        if (settings.prowlarr_session_cookie) {
          prowlarrCookieDisplay.value = settings.prowlarr_session_cookie;
          prowlarrCookieDisplay.placeholder = '';
          
          let prowlarrLabel = 'Prowlarr Cookie';
          if (settings.prowlarr_cookie_obtained_time) {
            prowlarrLabel += ' - Time/Date Obtained: ' + settings.prowlarr_cookie_obtained_time;
          }
          prowlarrCookieLabel.textContent = prowlarrLabel;
        } else {
          prowlarrCookieLabel.textContent = 'Prowlarr Cookie:';
        }
      })
      .catch(error => {
        console.log('Could not load existing cookies:', error);
      });
  }
  
  // Load existing cookies on page load
  loadExistingCookies();
  
  if (getIpsBtn) {
    getIpsBtn.addEventListener('click', function() {
      resultDiv.textContent = 'Fetching IPs...';
      debugDiv.style.display = 'none';
      toggleDebugBtn.style.display = 'none';
      
      fetch('/api/get_ips').then(r => r.json()).then(data => {
        let html = '';
        if (data.external_ip && data.external_ip !== 'Error') {
          html += `External IP: <span style='color:#007700'>${data.external_ip}</span><br>`;
        } else {
          html += `External IP: <span style='color:#bb0000'>Not found/Error</span><br>`;
        }
        if (data.vpn_ip && data.vpn_ip !== 'Not Found') {
          html += `VPN Container IP: <span style='color:#0077bb'>${data.vpn_ip}</span>`;
        } else {
          html += `VPN Container IP: <span style='color:#bb0000'>Not found</span>`;
        }
        resultDiv.innerHTML = html;
        
        // Show debug info if available
        if (data.debug_info && data.debug_info.length > 0) {
          debugDiv.textContent = data.debug_info.join('\n');
          toggleDebugBtn.style.display = 'inline-block';
          toggleDebugBtn.textContent = 'Show Debug';
        }
      }).catch((error) => {
        resultDiv.textContent = 'Failed to fetch IPs: ' + error.message;
      });
    });
  }
  
  if (toggleDebugBtn) {
    toggleDebugBtn.addEventListener('click', function() {
      if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
        toggleDebugBtn.textContent = 'Hide Debug';
      } else {
        debugDiv.style.display = 'none';
        toggleDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // Restart qBittorrentvpn button functionality
  if (restartQbittorrentBtn) {
    restartQbittorrentBtn.addEventListener('click', function() {
      restartResultDiv.textContent = 'Restarting qBittorrent container...';
      restartResultDiv.style.color = '#666';
      restartQbittorrentBtn.disabled = true;
      
      fetch('/api/restart_qbittorrent_container', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        restartQbittorrentBtn.disabled = false;
        
        if (data.success) {
          restartResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
        } else {
          restartResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show additional status updates if available
        if (data.status_updates && data.status_updates.length > 0) {
          restartResultDiv.innerHTML += '<br><small>' + data.status_updates.join('<br>') + '</small>';
        }
      }).catch(error => {
        restartQbittorrentBtn.disabled = false;
        restartResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Log into MAM button functionality
  if (loginMamBtn) {
    loginMamBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Logging into MAM using Selenium...';
      mamResultDiv.style.color = '#666';
      loginMamBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/login_mam', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        loginMamBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.redirect_url) {
            mamResultDiv.innerHTML += `<br><small>Redirected to: ${data.redirect_url}</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        loginMamBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // MAM debug toggle functionality
  if (toggleMamDebugBtn) {
    toggleMamDebugBtn.addEventListener('click', function() {
      if (mamDebugDiv.style.display === 'none') {
        mamDebugDiv.style.display = 'block';
        toggleMamDebugBtn.textContent = 'Hide Debug';
      } else {
        mamDebugDiv.style.display = 'none';
        toggleMamDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // View MAM Page button functionality - opens popup showing current global browser state
  if (viewMamPageBtn) {
    viewMamPageBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Getting current browser state...';
      mamResultDiv.style.color = '#666';
      
      // Get current state of global browser
      fetch('/api/view_mam_page')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Show status information
            let statusMsg = data.logged_in ? 'Logged in' : 'Not logged in';
            mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${statusMsg} - Opening current page in new window</span>`;
            
            // Open the CURRENT URL of the global browser in a new window
            const currentUrl = data.url || 'https://www.myanonamouse.net/';
            const newWindow = window.open(currentUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (newWindow) {
              mamResultDiv.innerHTML += `<br><small>Opened: ${data.title || currentUrl}</small>`;
            } else {
              mamResultDiv.innerHTML += `<br><span style='color:#bb0000'>⚠ Popup blocked - please allow popups for this site</span>`;
            }
          } else {
            mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Error: ${data.error}</span>`;
          }
        })
        .catch(error => {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Error: ${error.message}</span>`;
        });
    });
  }
  
  // View Sessions button functionality
  if (viewSessionsBtn) {
    viewSessionsBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Loading sessions page...';
      mamResultDiv.style.color = '#666';
      viewSessionsBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/view_sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        viewSessionsBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.session_count) {
            mamResultDiv.innerHTML += `<br><small>Sessions found: ${data.session_count}</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        viewSessionsBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Delete Old Sessions button functionality
  if (deleteOldSessionsBtn) {
    deleteOldSessionsBtn.addEventListener('click', function() {
      // Confirmation dialog
      if (!confirm('Are you sure you want to delete all old sessions except the newest one? This action cannot be undone.')) {
        return;
      }
      
      mamResultDiv.textContent = 'Deleting old sessions...';
      mamResultDiv.style.color = '#666';
      deleteOldSessionsBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/delete_old_sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        deleteOldSessionsBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.deleted_count !== undefined) {
            mamResultDiv.innerHTML += `<br><small>Deleted: ${data.deleted_count} sessions</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        deleteOldSessionsBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Create qBittorrent Session Cookie button functionality
  if (createQbittorrentSessionBtn) {
    createQbittorrentSessionBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Creating qBittorrent session cookie...';
      mamResultDiv.style.color = '#666';
      createQbittorrentSessionBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/create_qbittorrent_cookie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        createQbittorrentSessionBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          
          // Update the cookie display
          loadExistingCookies();
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        createQbittorrentSessionBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Create Prowlarr Session Cookie button functionality
  if (createProwlarrSessionBtn) {
    createProwlarrSessionBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Creating Prowlarr session cookie...';
      mamResultDiv.style.color = '#666';
      createProwlarrSessionBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/create_prowlarr_cookie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        createProwlarrSessionBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          
          // Update the cookie display
          loadExistingCookies();
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        createProwlarrSessionBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Logout MAM button functionality
  if (logoutMamBtn) {
    logoutMamBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Logging out from MAM (closing browser)...';
      mamResultDiv.style.color = '#666';
      logoutMamBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/logout_mam', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        logoutMamBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
      }).catch(error => {
        logoutMamBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Clear Cookies button functionality
  if (clearCookiesBtn) {
    clearCookiesBtn.addEventListener('click', function() {
      // Confirmation dialog
      if (!confirm('Are you sure you want to clear both session cookies? This will set them to "0" and update the timestamps.')) {
        return;
      }
      
      mamResultDiv.textContent = 'Clearing session cookies...';
      mamResultDiv.style.color = '#666';
      clearCookiesBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/clear_cookies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        clearCookiesBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.timestamp) {
            mamResultDiv.innerHTML += `<br><small>Cleared at: ${data.timestamp}</small>`;
          }
          
          // Update the cookie display to show cleared cookies
          loadExistingCookies();
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
      }).catch(error => {
        clearCookiesBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // qBittorrent debug toggle functionality
  if (toggleQbittorrentDebugBtn) {
    toggleQbittorrentDebugBtn.addEventListener('click', function() {
      if (qbittorrentDebugDiv.style.display === 'none') {
        qbittorrentDebugDiv.style.display = 'block';
        toggleQbittorrentDebugBtn.textContent = 'Hide Debug';
      } else {
        qbittorrentDebugDiv.style.display = 'none';
        toggleQbittorrentDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // qBittorrent Login button functionality
  if (qbittorrentLoginBtn) {
    qbittorrentLoginBtn.addEventListener('click', function() {
      qbittorrentResultDiv.textContent = 'Connecting to qBittorrent container...';
      qbittorrentResultDiv.style.color = '#666';
      qbittorrentLoginBtn.disabled = true;
      qbittorrentDebugDiv.style.display = 'none';
      toggleQbittorrentDebugBtn.style.display = 'none';
      
      fetch('/api/qbittorrent_login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        qbittorrentLoginBtn.disabled = false;
        
        if (data.success) {
          qbittorrentResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
        } else {
          qbittorrentResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          qbittorrentDebugDiv.textContent = data.debug_info.join('\n');
          toggleQbittorrentDebugBtn.style.display = 'inline-block';
          toggleQbittorrentDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        qbittorrentLoginBtn.disabled = false;
        qbittorrentResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // qBittorrent Send Cookie button functionality
  if (qbittorrentSendCookieBtn) {
    qbittorrentSendCookieBtn.addEventListener('click', function() {
      qbittorrentResultDiv.textContent = 'Sending qBittorrent cookie to MAM...';
      qbittorrentResultDiv.style.color = '#666';
      qbittorrentSendCookieBtn.disabled = true;
      qbittorrentDebugDiv.style.display = 'none';
      toggleQbittorrentDebugBtn.style.display = 'none';
      
      fetch('/api/qbittorrent_send_cookie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        qbittorrentSendCookieBtn.disabled = false;
        
        if (data.success) {
          qbittorrentResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.response) {
            // Show a truncated version of the response
            let responsePreview = data.response.length > 100 ? 
              data.response.substring(0, 100) + '...' : data.response;
            qbittorrentResultDiv.innerHTML += `<br><small>Response: ${responsePreview}</small>`;
          }
        } else {
          qbittorrentResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
          if (data.response) {
            qbittorrentResultDiv.innerHTML += `<br><small>Response: ${data.response}</small>`;
          }
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          qbittorrentDebugDiv.textContent = data.debug_info.join('\n');
          toggleQbittorrentDebugBtn.style.display = 'inline-block';
          toggleQbittorrentDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        qbittorrentSendCookieBtn.disabled = false;
        qbittorrentResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // qBittorrent Logout button functionality
  if (qbittorrentLogoutBtn) {
    qbittorrentLogoutBtn.addEventListener('click', function() {
      qbittorrentResultDiv.textContent = 'Disconnecting from qBittorrent container...';
      qbittorrentResultDiv.style.color = '#666';
      qbittorrentLogoutBtn.disabled = true;
      qbittorrentDebugDiv.style.display = 'none';
      toggleQbittorrentDebugBtn.style.display = 'none';
      
      fetch('/api/qbittorrent_logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        qbittorrentLogoutBtn.disabled = false;
        
        if (data.success) {
          qbittorrentResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
        } else {
          qbittorrentResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          qbittorrentDebugDiv.textContent = data.debug_info.join('\n');
          toggleQbittorrentDebugBtn.style.display = 'inline-block';
          toggleQbittorrentDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        qbittorrentLogoutBtn.disabled = false;
        qbittorrentResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Prowlarr debug toggle functionality
  if (toggleProwlarrDebugBtn) {
    toggleProwlarrDebugBtn.addEventListener('click', function() {
      if (prowlarrDebugDiv.style.display === 'none') {
        prowlarrDebugDiv.style.display = 'block';
        toggleProwlarrDebugBtn.textContent = 'Hide Debug';
      } else {
        prowlarrDebugDiv.style.display = 'none';
        toggleProwlarrDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // Prowlarr Login button functionality
  if (prowlarrLoginBtn) {
    prowlarrLoginBtn.addEventListener('click', function() {
      prowlarrResultDiv.textContent = 'Connecting to Prowlarr web interface...';
      prowlarrResultDiv.style.color = '#666';
      prowlarrLoginBtn.disabled = true;
      prowlarrDebugDiv.style.display = 'none';
      toggleProwlarrDebugBtn.style.display = 'none';
      
      fetch('/api/prowlarr_login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        prowlarrLoginBtn.disabled = false;
        
        if (data.success) {
          prowlarrResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.page_title) {
            prowlarrResultDiv.innerHTML += `<br><small>Page: ${data.page_title}</small>`;
          }
        } else {
          prowlarrResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          prowlarrDebugDiv.textContent = data.debug_info.join('\n');
          toggleProwlarrDebugBtn.style.display = 'inline-block';
          toggleProwlarrDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        prowlarrLoginBtn.disabled = false;
        prowlarrResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Prowlarr Send Cookie button functionality
  if (prowlarrSendCookieBtn) {
    prowlarrSendCookieBtn.addEventListener('click', function() {
      prowlarrResultDiv.textContent = 'Updating Prowlarr MyAnonamouse indexer...';
      prowlarrResultDiv.style.color = '#666';
      prowlarrSendCookieBtn.disabled = true;
      prowlarrDebugDiv.style.display = 'none';
      toggleProwlarrDebugBtn.style.display = 'none';
      
      fetch('/api/prowlarr_send_cookie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        prowlarrSendCookieBtn.disabled = false;
        
        if (data.success) {
          prowlarrResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.test_result) {
            let testIcon = data.test_result === 'success' ? '✓' : 
                          data.test_result === 'failure' ? '✗' : '⚠';
            let testColor = data.test_result === 'success' ? '#007700' : 
                           data.test_result === 'failure' ? '#bb0000' : '#ff8800';
            prowlarrResultDiv.innerHTML += `<br><small>Test Result: <span style='color:${testColor}'>${testIcon} ${data.test_result}</span></small>`;
          }
        } else {
          prowlarrResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
          if (data.test_result) {
            prowlarrResultDiv.innerHTML += `<br><small>Test Result: ${data.test_result}</small>`;
          }
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          prowlarrDebugDiv.textContent = data.debug_info.join('\n');
          toggleProwlarrDebugBtn.style.display = 'inline-block';
          toggleProwlarrDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        prowlarrSendCookieBtn.disabled = false;
        prowlarrResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // Prowlarr Logout button functionality
  if (prowlarrLogoutBtn) {
    prowlarrLogoutBtn.addEventListener('click', function() {
      prowlarrResultDiv.textContent = 'Closing Prowlarr browser session...';
      prowlarrResultDiv.style.color = '#666';
      prowlarrLogoutBtn.disabled = true;
      prowlarrDebugDiv.style.display = 'none';
      toggleProwlarrDebugBtn.style.display = 'none';
      
      fetch('/api/prowlarr_logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        prowlarrLogoutBtn.disabled = false;
        
        if (data.success) {
          prowlarrResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
        } else {
          prowlarrResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          prowlarrDebugDiv.textContent = data.debug_info.join('\n');
          toggleProwlarrDebugBtn.style.display = 'inline-block';
          toggleProwlarrDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        prowlarrLogoutBtn.disabled = false;
        prowlarrResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
});
</script>
{% endblock %}
