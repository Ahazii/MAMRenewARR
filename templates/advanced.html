{% extends "base.html" %}
{% block content %}
<h2>Advanced Mode</h2>
<div class="box">
  <h3>Step 1</h3>
  <div class="button-row">
    <button id="get-ips-btn" title="Open a log file and work out what the External IP address is, and get Prowlarr IP">Get IP's</button>
    <button id="toggle-debug-btn" title="Show/Hide debug information" style="display:none;">Show Debug</button>
  </div>
  <div id="ips-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="debug-info" style="margin-top:1em;font-size:0.8em;color:#666;background:#f5f5f5;padding:0.5em;border-radius:4px;white-space:pre-line;max-height:200px;overflow-y:auto;display:none;"></div>
</div>
<div class="box">
  <h3>Step 2</h3>
  <div class="button-row">
    <button id="login-mam-btn" title="Open and Log into the Website called Myanonymouse">Log into MAM</button>
    <button id="login-mam-selenium-btn" title="Login using Selenium (JavaScript enabled)">Selenium Login</button>
    <button id="view-mam-page-btn" title="Open MAM website in a new browser window">Open MAM Page</button>
    <button title="Switch to the security page of myananamouse">View Sessions</button>
    <button title="Delete all of the old sessions">Delete old Sessions</button>
    <button title="Creates a new session for Myanonamouse qbtitorrent client that is ASN Locked and Allow Session to set Dynamic SeedBox. Copy cookie generated by Myanonamouse">Create qBittorrent Session</button>
    <button title="Creates a session for the Prowlarr Docker">Create Prowlarr Session</button>
    <button title="Logout of MAM">Logout MAM</button>
  </div>
  <div id="mam-result" style="margin-top:1em;font-weight:600;"></div>
  <div id="mam-debug" style="margin-top:0.5em;font-size:0.8em;color:#666;background:#f5f5f5;padding:0.5em;border-radius:4px;white-space:pre-line;max-height:200px;overflow-y:auto;display:none;"></div>
  <button id="toggle-mam-debug" style="margin-top:0.5em;display:none;" title="Show/Hide MAM debug information">Show Debug</button>
</div>
<div class="box">
  <h3>Step 3</h3>
  <div class="button-row">
    <button title="Open a console window on the Qbittorrent docker">Log into qBittorrent</button>
    <button title="Send the cookie to qbittorrent in a command and check success">Send Cookie to qBittorrent</button>
    <button title="Logout of qBittorrent">Logout qBittorrent</button>
  </div>
</div>
<div class="box">
  <h3>Step 4</h3>
  <div class="button-row">
    <button title="Open window into the Prowlarr Docker">Log into Prowlarr</button>
    <button title="Send Prowlarr Cookie">Send Prowlarr Cookie</button>
    <button title="Logout of Prowlarr">Logout of Prowlarr</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const getIpsBtn = document.getElementById('get-ips-btn');
  const toggleDebugBtn = document.getElementById('toggle-debug-btn');
  const resultDiv = document.getElementById('ips-result');
  const debugDiv = document.getElementById('debug-info');
  const loginMamBtn = document.getElementById('login-mam-btn');
  const loginMamSeleniumBtn = document.getElementById('login-mam-selenium-btn');
  const viewMamPageBtn = document.getElementById('view-mam-page-btn');
  const mamResultDiv = document.getElementById('mam-result');
  const mamDebugDiv = document.getElementById('mam-debug');
  const toggleMamDebugBtn = document.getElementById('toggle-mam-debug');
  
  if (getIpsBtn) {
    getIpsBtn.addEventListener('click', function() {
      resultDiv.textContent = 'Fetching IPs...';
      debugDiv.style.display = 'none';
      toggleDebugBtn.style.display = 'none';
      
      fetch('/api/get_ips').then(r => r.json()).then(data => {
        let html = '';
        if (data.external_ip && data.external_ip !== 'Error') {
          html += `External IP: <span style='color:#007700'>${data.external_ip}</span><br>`;
        } else {
          html += `External IP: <span style='color:#bb0000'>Not found/Error</span><br>`;
        }
        if (data.vpn_ip && data.vpn_ip !== 'Not Found') {
          html += `VPN Container IP: <span style='color:#0077bb'>${data.vpn_ip}</span>`;
        } else {
          html += `VPN Container IP: <span style='color:#bb0000'>Not found</span>`;
        }
        resultDiv.innerHTML = html;
        
        // Show debug info if available
        if (data.debug_info && data.debug_info.length > 0) {
          debugDiv.textContent = data.debug_info.join('\n');
          toggleDebugBtn.style.display = 'inline-block';
          toggleDebugBtn.textContent = 'Show Debug';
        }
      }).catch((error) => {
        resultDiv.textContent = 'Failed to fetch IPs: ' + error.message;
      });
    });
  }
  
  if (toggleDebugBtn) {
    toggleDebugBtn.addEventListener('click', function() {
      if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
        toggleDebugBtn.textContent = 'Hide Debug';
      } else {
        debugDiv.style.display = 'none';
        toggleDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // Log into MAM button functionality
  if (loginMamBtn) {
    loginMamBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Logging into MAM...';
      mamResultDiv.style.color = '#666';
      loginMamBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/login_mam', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        loginMamBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.redirect_url) {
            mamResultDiv.innerHTML += `<br><small>Redirected to: ${data.redirect_url}</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        loginMamBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // MAM debug toggle functionality
  if (toggleMamDebugBtn) {
    toggleMamDebugBtn.addEventListener('click', function() {
      if (mamDebugDiv.style.display === 'none') {
        mamDebugDiv.style.display = 'block';
        toggleMamDebugBtn.textContent = 'Hide Debug';
      } else {
        mamDebugDiv.style.display = 'none';
        toggleMamDebugBtn.textContent = 'Show Debug';
      }
    });
  }
  
  // Selenium Log into MAM button functionality
  if (loginMamSeleniumBtn) {
    loginMamSeleniumBtn.addEventListener('click', function() {
      mamResultDiv.textContent = 'Logging into MAM with Selenium...';
      mamResultDiv.style.color = '#666';
      loginMamSeleniumBtn.disabled = true;
      mamDebugDiv.style.display = 'none';
      toggleMamDebugBtn.style.display = 'none';
      
      fetch('/api/login_mam_selenium', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        loginMamSeleniumBtn.disabled = false;
        
        if (data.success) {
          mamResultDiv.innerHTML = `<span style='color:#007700'>✓ ${data.message}</span>`;
          if (data.redirect_url) {
            mamResultDiv.innerHTML += `<br><small>Redirected to: ${data.redirect_url}</small>`;
          }
        } else {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ ${data.message}</span>`;
        }
        
        // Show debug information if available
        if (data.debug_info && data.debug_info.length > 0) {
          mamDebugDiv.textContent = data.debug_info.join('\n');
          toggleMamDebugBtn.style.display = 'inline-block';
          toggleMamDebugBtn.textContent = 'Show Debug';
        }
      }).catch(error => {
        loginMamSeleniumBtn.disabled = false;
        mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Network error: ${error.message}</span>`;
      });
    });
  }
  
  // View MAM Page button functionality - opens in new browser window
  if (viewMamPageBtn) {
    viewMamPageBtn.addEventListener('click', function() {
      // Get MAM URL from config or use default
      fetch('/api/settings')
        .then(r => r.json())
        .then(settings => {
          const mamUrl = settings.mam_url || 'https://www.myanonamouse.net/';
          
          // Open MAM in a new window/tab
          const newWindow = window.open(mamUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
          
          if (newWindow) {
            mamResultDiv.innerHTML = `<span style='color:#007700'>✓ Opened MAM in new window</span>`;
          } else {
            mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Popup blocked - please allow popups for this site</span>`;
          }
        })
        .catch(error => {
          mamResultDiv.innerHTML = `<span style='color:#bb0000'>✗ Error: ${error.message}</span>`;
        });
    });
  }
});
</script>
{% endblock %}
