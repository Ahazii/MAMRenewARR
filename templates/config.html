{% extends "base.html" %}
{% block content %}
<div class="theme-toggle-bar">
  <label for="theme-toggle">Light/Dark Mode:</label>
  <button id="theme-toggle" title="Toggle light/dark mode">ğŸŒ/ğŸŒœ</button>
</div>
<h2>Config Page</h2>
<div class="box config-fields">
  <h3>MyAnonamouseRenewarr</h3>
  <label for="config-folder">Config Folder:</label>
  <input type="text" id="config-folder" value="/mnt/user/appdata/MyAnonamouseRenewarr" title="Path to the docker's setting file">
  <label for="loglevel">LogLevel:</label>
  <select id="loglevel">
    <option value="Info">Info</option>
    <option value="Debug">Debug</option>
  </select>
  <label for="mam-url">Myanonamouse url:</label>
  <input type="text" id="mam-url" value="https://www.myanonamouse.net/">
  <label for="mam-username">MAM Username:</label>
  <input type="text" id="mam-username" placeholder="Your MAM username">
  <label for="mam-password">MAM Password:</label>
  <div style="display:flex;align-items:center;gap:0.5em;">
    <input type="password" id="mam-password" placeholder="Your MAM password">
    <button type="button" id="mam-password-toggle" title="Show/Hide password">ğŸ‘ï¸</button>
  </div>
  <label for="security-page">Security Page:</label>
  <input type="text" id="security-page" value="https://www.myanonamouse.net/preferences/index.php?view=security">
</div>
<div class="box config-fields">
  <h3>Basic Mode Timer Settings</h3>
  <label for="scheduled-run-time">Scheduled Run Time (HH:MM):</label>
  <input type="time" id="scheduled-run-time" value="02:00" title="Time of day to run automated tasks (24-hour format, e.g., 14:30 for 2:30 PM)">
  <small style="display:block;margin-top:0.3em;color:#666;">Enter the time when you want automated tasks to run daily.</small>
  <label for="jitter-minutes" style="margin-top:1em;">Jitter (minutes):</label>
  <input type="number" id="jitter-minutes" value="10" min="0" max="60" title="Random minutes to add or subtract from scheduled time (e.g., 10 means run between -10 to +10 minutes of scheduled time)">
  <small style="display:block;margin-top:0.3em;color:#666;">Random variance (Â±) added to scheduled time. For example, if set to 10 minutes, tasks will run within Â±10 minutes of the scheduled time.</small>
</div>
<div class="box config-fields">
  <h3>Unraid</h3>
  <label for="unraid-ip">Unraid IP:</label>
  <input type="text" id="unraid-ip" value="192.168.1.55">
  <label for="unraid-username">Username:</label>
  <input type="text" id="unraid-username" value="root">
  <label for="unraid-password">Password:</label>
  <div style="display:flex;align-items:center;gap:0.5em;">
    <input type="password" id="unraid-password">
    <button title="Show/Hide password">ğŸ‘ï¸</button>
  </div>
</div>
<div class="box config-fields">
  <h3>Prowlarr</h3>
  <label for="prowlarr-url">Prowlarr url:</label>
  <input type="text" id="prowlarr-url" value="192.168.1.55:9696">
  <label for="prowlarr-username">Prowlarr Username:</label>
  <input type="text" id="prowlarr-username" placeholder="Not needed if auth disabled for local network">
  <label for="prowlarr-password">Prowlarr Password:</label>
  <div style="display:flex;align-items:center;gap:0.5em;">
    <input type="password" id="prowlarr-password" placeholder="Not needed if auth disabled for local network">
    <button id="prowlarr-password-toggle" title="Show/Hide password">ğŸ‘ï¸</button>
  </div>
</div>
<div class="box config-fields">
  <h3>qBittorrentVPN</h3>
  <label for="qbittorrentvpn-container">Container Name:</label>
  <input type="text" id="qbittorrentvpn-container" value="binhex-qbittorrentvpn" title="Name of the qBittorrentVPN Docker container">
  <label for="qbittorrentvpn-logpath">Log File Path:</label>
  <input type="text" id="qbittorrentvpn-logpath" value="/app/shared/qbittorrent-logs/qbittorrent.log" title="Path to the host-mounted qBittorrent log inside this container">
  <label for="qbittorrent-url">qBittorrent URL:</label>
  <input type="text" id="qbittorrent-url" value="http://192.168.1.55:8080" title="URL to access qBittorrent web UI (e.g., http://192.168.1.55:8080). Used to verify the container has restarted successfully.">
  <label for="qbittorrent-restart-delay">Restart Delay (seconds):</label>
  <input type="number" id="qbittorrent-restart-delay" value="120" min="30" max="600" title="Maximum time (in seconds) to wait for qBittorrent container to restart and become accessible. Also used as delay between stop and start in fallback scenario.">
</div>
<div class="box button-row">
  <button title="Save config changes">Save Config</button>
  <button title="Revert config changes">Cancel</button>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const containerInput = document.getElementById('qbittorrentvpn-container');
  const logpathInput = document.getElementById('qbittorrentvpn-logpath');
  const qbittorrentUrlInput = document.getElementById('qbittorrent-url');
  const qbittorrentRestartDelayInput = document.getElementById('qbittorrent-restart-delay');
  const mamUrlInput = document.getElementById('mam-url');
  const mamUsernameInput = document.getElementById('mam-username');
  const mamPasswordInput = document.getElementById('mam-password');
  const mamPasswordToggle = document.getElementById('mam-password-toggle');
  const securityPageInput = document.getElementById('security-page');
  const scheduledRunTimeInput = document.getElementById('scheduled-run-time');
  const jitterMinutesInput = document.getElementById('jitter-minutes');
  const loglevelSelect = document.getElementById('loglevel');
  const prowlarrUrlInput = document.getElementById('prowlarr-url');
  const prowlarrUsernameInput = document.getElementById('prowlarr-username');
  const prowlarrPasswordInput = document.getElementById('prowlarr-password');
  const prowlarrPasswordToggle = document.getElementById('prowlarr-password-toggle');
  const saveBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.trim() === 'Save Config');
  const cancelBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.trim() === 'Cancel');

  // Load settings from backend
  function loadSettings() {
    fetch('/api/settings').then(r => r.json()).then(data => {
      if (data.qbittorrentvpn_container) containerInput.value = data.qbittorrentvpn_container;
      if (data.qbittorrentvpn_logpath) logpathInput.value = data.qbittorrentvpn_logpath;
      if (data.qbittorrent_url) qbittorrentUrlInput.value = data.qbittorrent_url;
      if (data.qbittorrent_restart_delay) qbittorrentRestartDelayInput.value = data.qbittorrent_restart_delay;
      if (data.mam_url) mamUrlInput.value = data.mam_url;
      if (data.mam_username) mamUsernameInput.value = data.mam_username;
      if (data.mam_password) mamPasswordInput.value = data.mam_password;
      if (data.security_page) securityPageInput.value = data.security_page;
      if (data.scheduled_run_time) scheduledRunTimeInput.value = data.scheduled_run_time;
      if (data.jitter_minutes) jitterMinutesInput.value = data.jitter_minutes;
      if (data.loglevel) loglevelSelect.value = data.loglevel;
      if (data.prowlarr_url) prowlarrUrlInput.value = data.prowlarr_url;
      if (data.prowlarr_username) prowlarrUsernameInput.value = data.prowlarr_username;
      if (data.prowlarr_password) prowlarrPasswordInput.value = data.prowlarr_password;
    });
  }

  // Save settings to backend
  function saveSettings() {
    const data = {
      qbittorrentvpn_container: containerInput.value,
      qbittorrentvpn_logpath: logpathInput.value,
      qbittorrent_url: qbittorrentUrlInput.value,
      qbittorrent_restart_delay: qbittorrentRestartDelayInput.value,
      mam_url: mamUrlInput.value,
      mam_username: mamUsernameInput.value,
      mam_password: mamPasswordInput.value,
      security_page: securityPageInput.value,
      scheduled_run_time: scheduledRunTimeInput.value,
      jitter_minutes: jitterMinutesInput.value,
      loglevel: loglevelSelect.value,
      prowlarr_url: prowlarrUrlInput.value,
      prowlarr_username: prowlarrUsernameInput.value,
      prowlarr_password: prowlarrPasswordInput.value
    };
    fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(r => r.json()).then(() => {
      alert('Config saved!');
    });
  }

  // Revert changes
  function revertSettings() {
    loadSettings();
  }

  // Password toggle functionality
  if (mamPasswordToggle) {
    mamPasswordToggle.addEventListener('click', function() {
      if (mamPasswordInput.type === 'password') {
        mamPasswordInput.type = 'text';
        mamPasswordToggle.textContent = 'ğŸ™ˆ';
      } else {
        mamPasswordInput.type = 'password';
        mamPasswordToggle.textContent = 'ğŸ‘ï¸';
      }
    });
  }
  
  if (prowlarrPasswordToggle) {
    prowlarrPasswordToggle.addEventListener('click', function() {
      if (prowlarrPasswordInput.type === 'password') {
        prowlarrPasswordInput.type = 'text';
        prowlarrPasswordToggle.textContent = 'ğŸ™ˆ';
      } else {
        prowlarrPasswordInput.type = 'password';
        prowlarrPasswordToggle.textContent = 'ğŸ‘ï¸';
      }
    });
  }

  if (saveBtn) saveBtn.addEventListener('click', saveSettings);
  if (cancelBtn) cancelBtn.addEventListener('click', revertSettings);
  loadSettings();
});
</script>
{% endblock %}
